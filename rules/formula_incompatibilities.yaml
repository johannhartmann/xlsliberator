# Formula incompatibility patterns between Excel and LibreOffice Calc
# Used by AI-based formula repair in fix_native_ods.py

indirect_address_cross_sheet:
  name: "INDIRECT/ADDRESS with Cross-Sheet References"
  severity: critical
  impact: "~20,196 formulas (98% of remaining mismatches)"

  description: |
    Excel's ADDRESS() function accepts a sheet name as 5th parameter:
    ADDRESS(row, col, abs_type, a1_notation, "SheetName")

    LibreOffice Calc does NOT support this - ADDRESS() only takes 4 parameters.
    The sheet name parameter causes #NAME? errors.

  excel_syntax: "INDIRECT(ADDRESS(row, col, abs, a1, \"SheetName\"))"

  calc_syntax: "INDIRECT(\"$SheetName.\" & ADDRESS(row, col, abs, a1))"

  fix_strategy: |
    1. Identify ADDRESS() calls with 5 parameters where 5th is a sheet name string
    2. Extract the sheet name from the 5th parameter
    3. Remove the 5th parameter (keep only first 4)
    4. Prepend "$SheetName." & to the ADDRESS() result
    5. This creates a full sheet-qualified address string that INDIRECT() can use

  examples:
    - description: "Simple INDIRECT with ADDRESS"
      excel: '=INDIRECT(ADDRESS(10,5,1,1,"Sheet1"))'
      calc: '=INDIRECT("$Sheet1." & ADDRESS(10,5,1,1))'

    - description: "INDIRECT/ADDRESS with dynamic row/column"
      excel: '=INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))'
      calc: '=INDIRECT("$Spielplan." & ADDRESS(48+COLUMN(),12,1,1))'

    - description: "Complex nested formula"
      excel: '=IF(INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))="ja",INDIRECT(ADDRESS(IF(MOD(B$1,2)=0,25,12),(ROW()-2)*2+4,1,1,"1-2")),"")'
      calc: '=IF(INDIRECT("$Spielplan." & ADDRESS(48+COLUMN(),12,1,1))="ja",INDIRECT("$1-2." & ADDRESS(IF(MOD(B$1,2)=0,25,12),(ROW()-2)*2+4,1,1)),"")'

    - description: "Multiple ADDRESS calls in one formula"
      excel: '=INDIRECT(ADDRESS(10,5,1,1,"A")) + INDIRECT(ADDRESS(20,10,1,1,"B"))'
      calc: '=INDIRECT("$A." & ADDRESS(10,5,1,1)) + INDIRECT("$B." & ADDRESS(20,10,1,1))'

  llm_prompt_template: |
    You are fixing Excel formulas for LibreOffice Calc compatibility.

    ISSUE: Excel's ADDRESS() function accepts a sheet name as the 5th parameter, but LibreOffice Calc does NOT support this.

    Excel formula:
    {excel_formula}

    FIX REQUIRED:
    Convert: ADDRESS(row, col, abs, a1, "SheetName")
    To:      "$SheetName." & ADDRESS(row, col, abs, a1)

    Then wrap in INDIRECT:
    Convert: INDIRECT(ADDRESS(..., "Sheet"))
    To:      INDIRECT("$Sheet." & ADDRESS(...))

    STEP-BY-STEP INSTRUCTIONS:
    1. Find ALL occurrences of ADDRESS() with 5 parameters
    2. For each ADDRESS() call:
       a. Extract the sheet name (5th parameter, a string literal)
       b. Remove the 5th parameter completely
       c. Prepend "$SheetName." & before the ADDRESS() call
    3. Preserve ALL other formula logic exactly (IF, MOD, COLUMN(), etc.)
    4. Handle nested cases carefully (formula may have multiple ADDRESS calls)
    5. Ensure the result formula is valid LibreOffice Calc syntax

    EXAMPLES:

    Input:  =INDIRECT(ADDRESS(10,5,1,1,"Sheet1"))
    Output: =INDIRECT("$Sheet1." & ADDRESS(10,5,1,1))

    Input:  =IF(INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))="ja",100,0)
    Output: =IF(INDIRECT("$Spielplan." & ADDRESS(48+COLUMN(),12,1,1))="ja",100,0)

    Input:  =INDIRECT(ADDRESS(R,C,1,1,"A")) + INDIRECT(ADDRESS(R2,C2,1,1,"B"))
    Output: =INDIRECT("$A." & ADDRESS(R,C,1,1)) + INDIRECT("$B." & ADDRESS(R2,C2,1,1))

    OUTPUT RULES:
    - Output ONLY the fixed formula
    - Start with = sign
    - No explanations, comments, or additional text
    - Ensure formula is valid Calc syntax

    Now fix the formula above:

text_formula_type_mismatch:
  name: "Text Formula Returning Numeric Type"
  severity: low
  impact: "1 formula"

  description: |
    Some formulas that should return text values return numeric 0.0 instead.
    This is usually due to type inference differences between Excel and Calc.

  fix_strategy: |
    Ensure text formulas explicitly return text type by using TEXT() or string concatenation.

other_calculation_differences:
  name: "Other Calculation Engine Differences"
  severity: medium
  impact: "~347 formulas"

  description: |
    Minor differences in how Excel and LibreOffice Calc calculate certain formulas.
    These need individual analysis.

  fix_strategy: |
    Manual review and case-by-case fixes.
