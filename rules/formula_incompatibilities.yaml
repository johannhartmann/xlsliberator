# Formula incompatibility patterns between Excel and LibreOffice Calc
# Used by AI-based formula repair in fix_native_ods.py

indirect_address_cross_sheet:
  name: "INDIRECT/ADDRESS with Cross-Sheet References"
  severity: critical
  impact: "~20,196 formulas (98% of remaining mismatches)"

  description: |
    Excel's ADDRESS() function accepts a sheet name as 5th parameter:
    ADDRESS(row, col, abs_type, a1_notation, "SheetName")

    LibreOffice Calc does NOT support this - ADDRESS() only takes 4 parameters.
    The sheet name parameter causes #NAME? errors.

  excel_syntax: "INDIRECT(ADDRESS(row, col, abs, a1, \"SheetName\"))"

  calc_syntax: "OFFSET(SheetName.A1, row-1, col-1)"

  fix_strategy: |
    1. Identify ADDRESS() calls with 5 parameters where 5th is a sheet name string
    2. Extract the sheet name from the 5th parameter
    3. Replace INDIRECT(ADDRESS(row,col,abs,a1,"Sheet")) with OFFSET(Sheet.A1,row-1,col-1)
    4. OFFSET is 0-indexed so row and col need -1
    5. IMPORTANT: LibreOffice INDIRECT does NOT support cross-sheet references, use OFFSET instead

  examples:
    - description: "Simple INDIRECT with ADDRESS"
      excel: '=INDIRECT(ADDRESS(10,5,1,1,"Sheet1"))'
      calc: '=INDIRECT("$Sheet1." & ADDRESS(10,5,1,1))'

    - description: "INDIRECT/ADDRESS with dynamic row/column"
      excel: '=INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))'
      calc: '=INDIRECT("$Spielplan." & ADDRESS(48+COLUMN(),12,1,1))'

    - description: "Complex nested formula"
      excel: '=IF(INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))="ja",INDIRECT(ADDRESS(IF(MOD(B$1,2)=0,25,12),(ROW()-2)*2+4,1,1,"1-2")),"")'
      calc: '=IF(INDIRECT("$Spielplan." & ADDRESS(48+COLUMN(),12,1,1))="ja",INDIRECT("$1-2." & ADDRESS(IF(MOD(B$1,2)=0,25,12),(ROW()-2)*2+4,1,1)),"")'

    - description: "Multiple ADDRESS calls in one formula"
      excel: '=INDIRECT(ADDRESS(10,5,1,1,"A")) + INDIRECT(ADDRESS(20,10,1,1,"B"))'
      calc: '=INDIRECT("$A." & ADDRESS(10,5,1,1)) + INDIRECT("$B." & ADDRESS(20,10,1,1))'

  llm_prompt_template: |
    You are fixing Excel formulas for LibreOffice Calc compatibility.

    ISSUE: Excel's ADDRESS() function accepts a sheet name as the 5th parameter, but LibreOffice Calc does NOT support this.

    Excel formula:
    {excel_formula}

    FIX REQUIRED:
    Convert: ADDRESS(row, col, abs, a1, "SheetName")
    To:      "SheetName." & ADDRESS(row, col, abs, a1)

    Then wrap in INDIRECT:
    Convert: INDIRECT(ADDRESS(..., "Sheet"))
    To:      INDIRECT("Sheet." & ADDRESS(...))

    IMPORTANT SHEET NAME QUOTING RULES:
    - If sheet name contains spaces, dashes, or starts with a number, wrap it in single quotes
    - Examples: "Sheet1." is fine, but "'1-2'." or "'My Sheet'." need quotes
    - The $ sign is NOT needed before the sheet name in this context
    - The sheet name goes INSIDE the double quotes that are part of the string concatenation

    STEP-BY-STEP INSTRUCTIONS:
    1. Find ALL occurrences of ADDRESS() with 5 parameters
    2. For each ADDRESS() call:
       a. Extract the sheet name (5th parameter, a string literal)
       b. Remove the 5th parameter completely
       c. If sheet name needs quoting (has special chars), use: "'SheetName'." & ADDRESS(...)
       d. If sheet name is simple, use: "SheetName." & ADDRESS(...)
    3. Preserve ALL other formula logic exactly (IF, MOD, COLUMN(), etc.)
    4. Handle nested cases carefully (formula may have multiple ADDRESS calls)
    5. Ensure the result formula is valid LibreOffice Calc syntax

    CORRECT EXAMPLES:

    Input:  =INDIRECT(ADDRESS(10,5,1,1,"Sheet1"))
    Output: =INDIRECT("Sheet1." & ADDRESS(10,5,1,1))

    Input:  =INDIRECT(ADDRESS(10,5,1,1,"1-2"))
    Output: =INDIRECT("'1-2'." & ADDRESS(10,5,1,1))

    Input:  =IF(INDIRECT(ADDRESS(48+COLUMN(),12,1,1,"Spielplan"))="ja",INDIRECT(ADDRESS(10,5,1,1,"3-4")),"")
    Output: =IF(INDIRECT("Spielplan." & ADDRESS(48+COLUMN(),12,1,1))="ja",INDIRECT("'3-4'." & ADDRESS(10,5,1,1)),"")

    WRONG EXAMPLES (DO NOT USE):
    - =INDIRECT("$Sheet1." & ADDRESS(...))  ❌ Extra $ sign
    - =INDIRECT("$'1-2'." & ADDRESS(...))   ❌ Extra $ sign with quotes
    - =INDIRECT(Sheet1. & ADDRESS(...))     ❌ Missing quotes around sheet name
    - =INDIRECT("1-2." & ADDRESS(...))      ❌ Missing single quotes for special chars

    OUTPUT RULES:
    - Output ONLY the fixed formula
    - Start with = sign
    - No explanations, comments, or additional text
    - Ensure formula is valid Calc syntax
    - Use the sheet name mapping provided after this prompt if available

    Now fix the formula above:

text_formula_type_mismatch:
  name: "Text Formula Returning Numeric Type"
  severity: low
  impact: "1 formula"

  description: |
    Some formulas that should return text values return numeric 0.0 instead.
    This is usually due to type inference differences between Excel and Calc.

  fix_strategy: |
    Ensure text formulas explicitly return text type by using TEXT() or string concatenation.

other_calculation_differences:
  name: "Other Calculation Engine Differences"
  severity: medium
  impact: "~347 formulas"

  description: |
    Minor differences in how Excel and LibreOffice Calc calculate certain formulas.
    These need individual analysis.

  fix_strategy: |
    Manual review and case-by-case fixes.
